1. Events（事件系統）
1.1 Purpose（目的）

English
The event store is an immutable append-only log representing all domain events that require webhook delivery.

中文
Event Store 是不可修改、只能追加的事件日誌，用於記錄所有需要被投遞的事件。

1.2 Table: events（事件主表）
Column	Type	Description
id	BIGINT PK	Auto-increment event ID
event_type	VARCHAR(100)	Event classification
created_at	TIMESTAMPTZ	Timestamp (UTC)
payload	JSON	Immutable event body
Indexes

INDEX idx_event_created (created_at)

INDEX idx_event_type (event_type, created_at)

1.3 Event Rules（事件規則）

English

Events cannot be updated or deleted.

All consumers must treat events as immutable truth.

If events originate externally, unique keys must enforce idempotency.

中文

Event 禁止更新或刪除。

所有消費者必須將 event 視為不可變來源。

若事件來自外部，必須使用唯一鍵保證冪等。

2. Subscriptions（訂閱系統）
2.1 Purpose（目的）

English
A subscription defines who should receive which events and where they should be delivered.

中文
Subscription 定義「誰應該收到哪些事件」以及「投遞的目標位置」。

2.2 Table: subscriptions（訂閱主表）
Column	Type	Description
id	BIGINT PK	Subscription ID
event_type	VARCHAR(100)	Subscribed event type
callback_url	VARCHAR(500)	HTTPS endpoint
active	BOOLEAN	Soft enable/disable
verified	BOOLEAN	Callback URL verification status
created_at	TIMESTAMPTZ	UTC
updated_at	TIMESTAMPTZ	UTC
Indexes

INDEX idx_sub_event_type (event_type)

INDEX idx_sub_active (active)

2.3 Subscription Rules（訂閱規則）
Rule 1 — Configuration Layer Only（僅為配置層）

English
Subscriptions must not execute orchestration or create side-effects.

中文
Subscription 只屬於配置層，不能包含流程邏輯，不得造成任何副作用。

Rule 2 — Validation（驗證規則）

English

callback_url must be HTTPS.

Verification is required before verified = 1.

中文

callback_url 必須為 HTTPS。

必須通過驗證流程才能標記 verified = 1。

Rule 3 — Activation Control（啟用規則）

English
Only subscriptions with active = 1 and verified = 1 may generate delivery sagas.

中文
只有 active = 1 且 verified = 1 的訂閱可以產生 delivery saga。

Rule 4 — Idempotency（訂閱冪等）

English
Routing may process the same event more than once, but must not produce duplicate sagas.

中文
Routing 可能重複處理相同事件，但 不能重複生成 saga。

此行為必須由 Saga 表的唯一鍵 (event_id, subscription_id) 保證（在 r01 明確定義）。

3. Event → Subscription Routing Logic（事件到訂閱的路由流程）
3.1 Trigger Timing（觸發時機）

English
When an event is inserted into events, routing must begin immediately or via asynchronous worker.

中文
當事件寫入 events 時，路由必須立即或由背景程序啟動。

3.2 Routing Steps（路由步驟）

English

For each new event:

Select all subscriptions where:

event_type = event.event_type

active = 1

verified = 1

For each subscription, create a saga idempotently:

Use INSERT … ON DUPLICATE KEY UPDATE

Enforced by Saga unique constraint (event_id, subscription_id)

Saga Orchestrator later creates the first job.

中文

對於每個新事件：

找出所有符合以下條件的訂閱：

event_type = event.event_type

active = 1

verified = 1

為每個訂閱 以冪等方式 建立 saga：

使用 INSERT … ON DUPLICATE KEY UPDATE

重複寫入會被 (event_id, subscription_id) 的 unique key 自動拒絕

Saga Orchestrator 隨後會建立第一個 job。

3.3 Routing Idempotency（路由冪等性）

English
Routing may be retried multiple times due to system failure, but the unique key in webhook_delivery_sagas guarantees that no duplicate sagas can be created.

中文
路由可能因錯誤而重試，但由於 saga 表的唯一鍵 (event_id, subscription_id)，同一事件對同一訂閱永遠只會產生一個 saga。

（此邏輯必須與 r01 保持一致。）

3.4 Routing MUST NOT（禁止行為）

English

Routing must never:

Modify events

Modify subscriptions

Create jobs

Change saga status

Interpret payload content

中文

路由層禁止：

修改 event

修改 subscription

建立 job

改變 saga 狀態

解讀 payload 內容

Routing 只做一件事：為每個有效訂閱建立 saga（以冪等方式）。

4. Permissions（權限）
4.1 event_ingest_writer

Allow:

INSERT events

SELECT events, subscriptions

Deny:

Update/delete events

Write to sagas/jobs/dead_letters

4.2 router_worker

Allow:

SELECT events / subscriptions

INSERT saga (idempotent)

Deny:

Create jobs

Change saga status

5. Non-Functional Requirements（非功能要求）
5.1 Performance

English
Subscription lists should be cached to avoid repeated DB loads.

中文
Subscription 建議快取，以減少 DB 查詢成本。

5.2 Idempotency Guarantee

English
Processing the same event twice must not create more than one saga for the same subscription.

中文
同一事件多次處理也必須保證只生成一筆 saga。

由 (event_id, subscription_id) unique key 強制保障。

6. Overall Interaction Summary（整體互動摘要）

This section consolidates r01/r02/r03/r04 to ensure no contradictions.

Event → Saga Creation

Routing creates saga (idempotent)

Saga state = Pending

Saga will create job later

Saga → Job Execution

Saga creates first job

Worker leases job

Worker finishes job

Saga processes result & transitions state

Retry / Dead Letter

Saga handles retry and backoff

Saga eventually marks as Completed or DeadLettered

DeadLetter system stores snapshot

Requeue creates a NEW saga (Pending)
