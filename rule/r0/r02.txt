Purpose（目的）

English
This document defines two execution-stage components:

The Job System, responsible for performing atomic webhook delivery attempts.

The Dead Letter System, responsible for storing permanently failed sagas and enabling controlled requeue.

中文
本文件定義兩個執行階段核心模組：

Job 系統：負責一次且僅一次的 webhook 投遞嘗試。

死信系統（Dead Letter）：保存永久失敗的 saga 並支援受控重新佇列。

2. Job System Specification（Job 系統規格）
2.1 Table: webhook_delivery_jobs
Column	Type	Description
id	BIGINT PK	Job ID
saga_id	BIGINT	Parent saga
status	ENUM	Pending, Leased, Completed, Failed
lease_until	TIMESTAMPTZ	Lease expiration timestamp
attempt_at	TIMESTAMPTZ	When job was created
response_status	INT	HTTP status (nullable)
error_code	VARCHAR(100)	Worker-reported error (nullable)
Indexes

INDEX idx_job_saga (saga_id)

INDEX idx_job_status_lease (status, lease_until)

UNIQUE uniq_job_saga_attempt (saga_id, attempt_at)
→ Enforces idempotency: Saga cannot accidentally create duplicate jobs for the same attempt.

2.2 Job Semantics（Job 行為語意）

English
A job represents exactly one attempt to deliver one payload to one subscription.

中文
Job 代表對某一 subscription 的一次且僅一次投遞嘗試。

Job Status Definitions

Pending
Job is ready to be leased by a worker.

Leased
Worker has claimed the job via:

SELECT … FOR UPDATE SKIP LOCKED


Only that worker may update its status.

Completed
Worker successfully delivered the HTTP request.

Failed
Worker attempted delivery but failed.
Saga Orchestrator determines retry logic—not the worker.

2.3 Worker Model（Worker 工作模型）
Worker MUST perform

English
Worker must:

Acquire a job using SELECT … FOR UPDATE SKIP LOCKED.

Immediately update:

status = 'Leased'

lease_until = now + lease_duration

Execute the HTTP request.

Report result:

Success → Completed, set response_status

Failure → Failed, set error_code

中文
Worker 必須：

以 SELECT … FOR UPDATE SKIP LOCKED 取得 job。

立即更新：

status = 'Leased'

lease_until = now + 租約時間

執行 HTTP 請求。

回報結果：

成功 → Completed（寫入 response_status）

失敗 → Failed（寫入 error_code）

Worker MUST NOT

English

Worker must never:

Modify saga status.

Modify saga attempt_count.

Create new jobs.

Decide whether to retry.

Decide whether to dead-letter.

中文

Worker 禁止：

修改 saga 狀態。

增加 attempt_count。

建立 job。

判定是否可重試。

判定是否進入死信。

2.4 Lease Expiration（租約到期處理）

English

If a worker crashes or becomes unhealthy:

When lease_until < now, the job is considered stale.

A background Lease Reset Cleaner must:

Select jobs where status = 'Leased' AND lease_until < now

Safely reset them to Pending

Ensure reset is idempotent

中文

若 worker 當機或失聯：

當 lease_until < now，job 視為過期。

背景 Lease Reset Cleaner 必須：

找出 status = 'Leased' AND lease_until < now 的 job

將其安全地重設為 Pending

重設操作必須具備冪等性

注意
job status 在過期時不會自動變 Pending，必須由 cleaner 處理。
（避免與 r01 相衝突：Saga 只能處理 job 結果，不負責 lease reset。）

3. Dead Letter System（死信系統）

這一段與 r01 已完全對齊並修正過去的邏輯矛盾。

3.1 Table: dead_letters
Column	Type	Description
id	BIGINT PK	Dead letter entry ID
saga_id	BIGINT	Original saga (immutable)
event_id	BIGINT	Event reference
subscription_id	BIGINT	Subscription reference
final_error_code	VARCHAR(100)	Final saga error
failed_at	TIMESTAMPTZ	Time saga entered DLQ
payload_snapshot	JSON	Full event payload snapshot
Indexes

INDEX idx_dead_saga (saga_id)

INDEX idx_dead_event (event_id)

Snapshot Definition（補強 r02 舊版缺漏）

payload_snapshot = event.payload 的完整複製
在 saga 進入 DeadLettered 當下建立，不可變更。

3.2 Dead Letter Semantics

English

Once a saga becomes DeadLettered:

A new row must be inserted into dead_letters.

The original saga becomes immutable forever.

No jobs may ever be created for this saga again.

Requeue must create a brand-new saga.

中文

Saga 進入 DeadLettered 後：

必須在 dead_letters 建立一筆新記錄。

原 saga 永久不可再被修改。

禁止再建立任何 job。

若要重新佇列，必須建立「全新的 saga」。

3.3 Requeue Logic（重新佇列邏輯）

以下內容已與 r01 修正後版本完全一致。

English

When requeue is requested:

Read the corresponding dead letter entry.

Create a new saga with:

same event_id

same subscription_id

status = Pending

attempt_count = 0

next_attempt_at = now

Do NOT create a job here.

Saga Orchestrator will produce the first job normally (consistent with r01).

The original saga stays dead forever.

中文

重新佇列時：

讀取死信資料。

建立一個「全新」的 saga：

沿用相同 event_id

沿用相同 subscription_id

status = Pending

attempt_count = 0

next_attempt_at = now

此處不建立第一個 job（與 r01 一致）。

Saga 會照正常規則從 Pending 產生第一個 job。

舊 saga 永遠保持 DeadLettered。

3.4 Requeue MUST NOT

English

Requeue must never:

Modify the old saga.

Reuse any old job.

Alter event payload.

Alter subscription config.

中文

重新佇列不得：

修改舊 saga。

重用 job。

修改 event payload。

修改 subscription 配置。

4. Permissions（權限模型）
4.1 Worker

Allow:

SELECT / UPDATE jobs

SELECT events, subscriptions, sagas

Deny:

INSERT saga

DELETE saga

Write to dead_letters

4.2 Saga Orchestrator

Allow:

SELECT / UPDATE sagas

INSERT jobs

UPDATE jobs

Read-only access to events/subscriptions

Deny:

DELETE sagas

Modify events/subscriptions

4.3 Dead Letter Operator

Allow:

SELECT dead_letters

Create new saga from dead letter（via application service only）

Deny:

UPDATE / DELETE sagas

UPDATE events

UPDATE subscriptions

5. Non-Functional Requirements
5.1 Job Throughput

English
Worker acquisition must avoid table scans and rely on (status, lease_until) index.

中文
Worker 取得 job 必須透過 (status, lease_until) 索引，禁止掃描全表。

5.2 Durability

English
All job writes must be atomic and strongly consistent.

中文
所有 job 寫入必須具備強一致性與原子性。

5.3 Observability

English
Jobs and dead letters must log:

saga_id

job_id

error_code

lease_expiration

worker_id

中文
job 與 dead letter 必須記錄：

saga_id

job_id

error_code

lease_expiration

worker_id
